<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>6 Session 6: Reproducible workflows revisited | Open Science Synthesis for the Delta Science Program: Week 3</title>
  <meta name="description" content="6 Session 6: Reproducible workflows revisited | Open Science Synthesis for the Delta Science Program: Week 3" />
  <meta name="generator" content="bookdown 0.24.3 and GitBook 2.6.7" />

  <meta property="og:title" content="6 Session 6: Reproducible workflows revisited | Open Science Synthesis for the Delta Science Program: Week 3" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="6 Session 6: Reproducible workflows revisited | Open Science Synthesis for the Delta Science Program: Week 3" />
  
  
  




  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="session-5-shiny.html"/>
<link rel="next" href="session-7-communicating-your-research-the-message-box.html"/>
<script src="libs/header-attrs-2.11/header-attrs.js"></script>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Open Science Synthesis for the Delta Science Program: Week 3</a>
<ul>
<li class="chapter" data-level="0.1" data-path="index.html"><a href="index.html#schedule"><i class="fa fa-check"></i><b>0.1</b> Schedule</a>
<ul>
<li class="chapter" data-level="0.1.1" data-path="index.html"><a href="index.html#code-of-conduct"><i class="fa fa-check"></i><b>0.1.1</b> Code of Conduct</a></li>
<li class="chapter" data-level="0.1.2" data-path="index.html"><a href="index.html#about-this-book"><i class="fa fa-check"></i><b>0.1.2</b> About this book</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="1" data-path="session-1-time-series-and-forecasting.html"><a href="session-1-time-series-and-forecasting.html"><i class="fa fa-check"></i><b>1</b> Session 1: Time Series and Forecasting</a>
<ul>
<li class="chapter" data-level="1.1" data-path="session-1-time-series-and-forecasting.html"><a href="session-1-time-series-and-forecasting.html#learning-objectives"><i class="fa fa-check"></i><b>1.1</b> Learning Objectives</a></li>
<li class="chapter" data-level="1.2" data-path="session-1-time-series-and-forecasting.html"><a href="session-1-time-series-and-forecasting.html#linear-regression-with-time-as-a-predictor"><i class="fa fa-check"></i><b>1.2</b> Linear regression, with time as a predictor</a></li>
<li class="chapter" data-level="1.3" data-path="session-1-time-series-and-forecasting.html"><a href="session-1-time-series-and-forecasting.html#time-series-feature-extraction"><i class="fa fa-check"></i><b>1.3</b> Time series ‘feature extraction’</a>
<ul>
<li class="chapter" data-level="1.3.1" data-path="session-1-time-series-and-forecasting.html"><a href="session-1-time-series-and-forecasting.html#the-predict-function-forecasting-with-a-fitted-regression-model"><i class="fa fa-check"></i><b>1.3.1</b> The ‘predict’ function: forecasting with a fitted regression model</a></li>
</ul></li>
<li class="chapter" data-level="1.4" data-path="session-1-time-series-and-forecasting.html"><a href="session-1-time-series-and-forecasting.html#time-series-objects-in-r"><i class="fa fa-check"></i><b>1.4</b> Time Series objects in R</a>
<ul>
<li class="chapter" data-level="1.4.1" data-path="session-1-time-series-and-forecasting.html"><a href="session-1-time-series-and-forecasting.html#autocorrelation-plots"><i class="fa fa-check"></i><b>1.4.1</b> Autocorrelation plots</a></li>
<li class="chapter" data-level="1.4.2" data-path="session-1-time-series-and-forecasting.html"><a href="session-1-time-series-and-forecasting.html#seasonal-trend-with-loess-smoothing-stl-decomposition"><i class="fa fa-check"></i><b>1.4.2</b> Seasonal Trend with Loess smoothing (STL) decomposition</a></li>
<li class="chapter" data-level="1.4.3" data-path="session-1-time-series-and-forecasting.html"><a href="session-1-time-series-and-forecasting.html#now-we-can-analyze-the-trend"><i class="fa fa-check"></i><b>1.4.3</b> Now we can analyze the trend</a></li>
<li class="chapter" data-level="1.4.4" data-path="session-1-time-series-and-forecasting.html"><a href="session-1-time-series-and-forecasting.html#some-time-series-model-acronyms"><i class="fa fa-check"></i><b>1.4.4</b> Some Time Series Model Acronyms</a></li>
<li class="chapter" data-level="1.4.5" data-path="session-1-time-series-and-forecasting.html"><a href="session-1-time-series-and-forecasting.html#state-space-models"><i class="fa fa-check"></i><b>1.4.5</b> State Space Models</a></li>
</ul></li>
<li class="chapter" data-level="1.5" data-path="session-1-time-series-and-forecasting.html"><a href="session-1-time-series-and-forecasting.html#ecological-forecasting"><i class="fa fa-check"></i><b>1.5</b> Ecological Forecasting</a>
<ul>
<li class="chapter" data-level="1.5.1" data-path="session-1-time-series-and-forecasting.html"><a href="session-1-time-series-and-forecasting.html#forecasting-challenges"><i class="fa fa-check"></i><b>1.5.1</b> Forecasting Challenges</a></li>
<li class="chapter" data-level="1.5.2" data-path="session-1-time-series-and-forecasting.html"><a href="session-1-time-series-and-forecasting.html#the-forecasting-toolbox"><i class="fa fa-check"></i><b>1.5.2</b> The forecasting toolbox</a></li>
</ul></li>
<li class="chapter" data-level="1.6" data-path="session-1-time-series-and-forecasting.html"><a href="session-1-time-series-and-forecasting.html#your-turn---some-actual-data"><i class="fa fa-check"></i><b>1.6</b> Your Turn - Some Actual Data!</a>
<ul>
<li class="chapter" data-level="1.6.1" data-path="session-1-time-series-and-forecasting.html"><a href="session-1-time-series-and-forecasting.html#example-1-a-twenty-year-history-of-weather-in-maricopa-az"><i class="fa fa-check"></i><b>1.6.1</b> Example 1: A twenty year history of weather in Maricopa, AZ</a></li>
<li class="chapter" data-level="1.6.2" data-path="session-1-time-series-and-forecasting.html"><a href="session-1-time-series-and-forecasting.html#autocorrelation"><i class="fa fa-check"></i><b>1.6.2</b> Autocorrelation</a></li>
</ul></li>
<li class="chapter" data-level="1.7" data-path="session-1-time-series-and-forecasting.html"><a href="session-1-time-series-and-forecasting.html#growth-curves"><i class="fa fa-check"></i><b>1.7</b> Growth Curves</a></li>
<li class="chapter" data-level="1.8" data-path="session-1-time-series-and-forecasting.html"><a href="session-1-time-series-and-forecasting.html#references"><i class="fa fa-check"></i><b>1.8</b> References</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="session-2-web-based-data-archival.html"><a href="session-2-web-based-data-archival.html"><i class="fa fa-check"></i><b>2</b> Session 2: Web based data archival</a>
<ul>
<li class="chapter" data-level="2.1" data-path="session-2-web-based-data-archival.html"><a href="session-2-web-based-data-archival.html#best-practices-data-and-metadata"><i class="fa fa-check"></i><b>2.1</b> Best Practices: Data and Metadata</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="session-2-web-based-data-archival.html"><a href="session-2-web-based-data-archival.html#learning-objectives-1"><i class="fa fa-check"></i><b>2.1.1</b> Learning Objectives</a></li>
<li class="chapter" data-level="2.1.2" data-path="session-2-web-based-data-archival.html"><a href="session-2-web-based-data-archival.html#best-practices-overview"><i class="fa fa-check"></i><b>2.1.2</b> Best Practices: Overview</a></li>
<li class="chapter" data-level="2.1.3" data-path="session-2-web-based-data-archival.html"><a href="session-2-web-based-data-archival.html#data-identifiers"><i class="fa fa-check"></i><b>2.1.3</b> Data Identifiers</a></li>
<li class="chapter" data-level="2.1.4" data-path="session-2-web-based-data-archival.html"><a href="session-2-web-based-data-archival.html#data-citation"><i class="fa fa-check"></i><b>2.1.4</b> Data Citation</a></li>
<li class="chapter" data-level="2.1.5" data-path="session-2-web-based-data-archival.html"><a href="session-2-web-based-data-archival.html#provanance-preserving-computational-workflows"><i class="fa fa-check"></i><b>2.1.5</b> Provanance &amp; Preserving Computational Workflows</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="session-2-web-based-data-archival.html"><a href="session-2-web-based-data-archival.html#data-documentation-and-publishing"><i class="fa fa-check"></i><b>2.2</b> Data Documentation and Publishing</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="session-2-web-based-data-archival.html"><a href="session-2-web-based-data-archival.html#learning-objectives-2"><i class="fa fa-check"></i><b>2.2.1</b> Learning Objectives</a></li>
<li class="chapter" data-level="2.2.2" data-path="session-2-web-based-data-archival.html"><a href="session-2-web-based-data-archival.html#data-sharing-and-preservation"><i class="fa fa-check"></i><b>2.2.2</b> Data sharing and preservation</a></li>
<li class="chapter" data-level="2.2.3" data-path="session-2-web-based-data-archival.html"><a href="session-2-web-based-data-archival.html#data-repositories-built-for-data-and-code"><i class="fa fa-check"></i><b>2.2.3</b> Data repositories: built for data (and code)</a></li>
<li class="chapter" data-level="2.2.4" data-path="session-2-web-based-data-archival.html"><a href="session-2-web-based-data-archival.html#metadata"><i class="fa fa-check"></i><b>2.2.4</b> Metadata</a></li>
<li class="chapter" data-level="2.2.5" data-path="session-2-web-based-data-archival.html"><a href="session-2-web-based-data-archival.html#structure-of-a-data-package"><i class="fa fa-check"></i><b>2.2.5</b> Structure of a data package</a></li>
<li class="chapter" data-level="2.2.6" data-path="session-2-web-based-data-archival.html"><a href="session-2-web-based-data-archival.html#dataone-federation"><i class="fa fa-check"></i><b>2.2.6</b> DataONE Federation</a></li>
<li class="chapter" data-level="" data-path="session-2-web-based-data-archival.html"><a href="session-2-web-based-data-archival.html#publishing-data-from-the-web"><i class="fa fa-check"></i>Publishing data from the web</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="session-3-programmatic-metadata-and-data-access.html"><a href="session-3-programmatic-metadata-and-data-access.html"><i class="fa fa-check"></i><b>3</b> Session 3: Programmatic metadata and data access</a>
<ul>
<li class="chapter" data-level="3.1" data-path="session-3-programmatic-metadata-and-data-access.html"><a href="session-3-programmatic-metadata-and-data-access.html#reproducible-data-access"><i class="fa fa-check"></i><b>3.1</b> Reproducible Data Access</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="session-3-programmatic-metadata-and-data-access.html"><a href="session-3-programmatic-metadata-and-data-access.html#learning-objectives-3"><i class="fa fa-check"></i><b>3.1.1</b> Learning Objectives</a></li>
<li class="chapter" data-level="3.1.2" data-path="session-3-programmatic-metadata-and-data-access.html"><a href="session-3-programmatic-metadata-and-data-access.html#barriers-to-data-access"><i class="fa fa-check"></i><b>3.1.2</b> Barriers to data access</a></li>
<li class="chapter" data-level="3.1.3" data-path="session-3-programmatic-metadata-and-data-access.html"><a href="session-3-programmatic-metadata-and-data-access.html#persistent-and-portable-data-access-for-improving-reproducibility"><i class="fa fa-check"></i><b>3.1.3</b> Persistent and portable data access for improving reproducibility</a></li>
<li class="chapter" data-level="3.1.4" data-path="session-3-programmatic-metadata-and-data-access.html"><a href="session-3-programmatic-metadata-and-data-access.html#storing-a-content-identifier-from-a-uri"><i class="fa fa-check"></i><b>3.1.4</b> Storing a content identifier from a URI</a></li>
<li class="chapter" data-level="3.1.5" data-path="session-3-programmatic-metadata-and-data-access.html"><a href="session-3-programmatic-metadata-and-data-access.html#loading-data-from-a-content-identifier"><i class="fa fa-check"></i><b>3.1.5</b> Loading data from a content identifier</a></li>
<li class="chapter" data-level="3.1.6" data-path="session-3-programmatic-metadata-and-data-access.html"><a href="session-3-programmatic-metadata-and-data-access.html#storing-and-using-local-data-identifiers"><i class="fa fa-check"></i><b>3.1.6</b> Storing and using local data identifiers</a></li>
<li class="chapter" data-level="3.1.7" data-path="session-3-programmatic-metadata-and-data-access.html"><a href="session-3-programmatic-metadata-and-data-access.html#improvements-to-content-identifiers"><i class="fa fa-check"></i><b>3.1.7</b> Improvements to content identifiers</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="session-3-programmatic-metadata-and-data-access.html"><a href="session-3-programmatic-metadata-and-data-access.html#programming-metadata-and-data-publishing"><i class="fa fa-check"></i><b>3.2</b> Programming Metadata and Data Publishing</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="session-3-programmatic-metadata-and-data-access.html"><a href="session-3-programmatic-metadata-and-data-access.html#learning-objectives-4"><i class="fa fa-check"></i><b>3.2.1</b> Learning Objectives</a></li>
<li class="chapter" data-level="3.2.2" data-path="session-3-programmatic-metadata-and-data-access.html"><a href="session-3-programmatic-metadata-and-data-access.html#creating-metadata"><i class="fa fa-check"></i><b>3.2.2</b> Creating Metadata</a></li>
<li class="chapter" data-level="3.2.3" data-path="session-3-programmatic-metadata-and-data-access.html"><a href="session-3-programmatic-metadata-and-data-access.html#publish-data-to-the-arctic-data-center-test-site"><i class="fa fa-check"></i><b>3.2.3</b> Publish data to the Arctic Data Center test site</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="session-4-model-analysis.html"><a href="session-4-model-analysis.html"><i class="fa fa-check"></i><b>4</b> Session 4: Model Analysis</a>
<ul>
<li class="chapter" data-level="4.1" data-path="session-4-model-analysis.html"><a href="session-4-model-analysis.html#learning-objectives-5"><i class="fa fa-check"></i><b>4.1</b> Learning Objectives</a></li>
<li class="chapter" data-level="4.2" data-path="session-4-model-analysis.html"><a href="session-4-model-analysis.html#comparing-models-to-data"><i class="fa fa-check"></i><b>4.2</b> Comparing models to data</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="session-4-model-analysis.html"><a href="session-4-model-analysis.html#statistical-tests-of-model-performance"><i class="fa fa-check"></i><b>4.2.1</b> Statistical tests of model performance</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="session-4-model-analysis.html"><a href="session-4-model-analysis.html#simulation-models"><i class="fa fa-check"></i><b>4.3</b> Simulation Models</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="session-4-model-analysis.html"><a href="session-4-model-analysis.html#example-a-leaf-level-model-of-photosynthesis"><i class="fa fa-check"></i><b>4.3.1</b> Example: A leaf level model of photosynthesis</a></li>
<li class="chapter" data-level="4.3.2" data-path="session-4-model-analysis.html"><a href="session-4-model-analysis.html#lets-run-this-model"><i class="fa fa-check"></i><b>4.3.2</b> Let’s run this model!</a></li>
<li class="chapter" data-level="4.3.3" data-path="session-4-model-analysis.html"><a href="session-4-model-analysis.html#variance-decomposition---which-of-these-parameters-are-most-important"><i class="fa fa-check"></i><b>4.3.3</b> Variance Decomposition - which of these parameters are most important?</a></li>
<li class="chapter" data-level="4.3.4" data-path="session-4-model-analysis.html"><a href="session-4-model-analysis.html#propagate-met-and-use-met-as-a-variable-sample-over-variation-within-the-hour"><i class="fa fa-check"></i><b>4.3.4</b> Propagate met and Use met as a variable, sample over variation within the hour</a></li>
<li class="chapter" data-level="4.3.5" data-path="session-4-model-analysis.html"><a href="session-4-model-analysis.html#references-1"><i class="fa fa-check"></i><b>4.3.5</b> References</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="session-5-shiny.html"><a href="session-5-shiny.html"><i class="fa fa-check"></i><b>5</b> Session 5: Shiny</a>
<ul>
<li class="chapter" data-level="5.1" data-path="session-5-shiny.html"><a href="session-5-shiny.html#introduction-to-shiny"><i class="fa fa-check"></i><b>5.1</b> Introduction to Shiny</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="session-5-shiny.html"><a href="session-5-shiny.html#learning-objectives-6"><i class="fa fa-check"></i><b>5.1.1</b> Learning Objectives</a></li>
<li class="chapter" data-level="5.1.2" data-path="session-5-shiny.html"><a href="session-5-shiny.html#overview"><i class="fa fa-check"></i><b>5.1.2</b> Overview</a></li>
<li class="chapter" data-level="5.1.3" data-path="session-5-shiny.html"><a href="session-5-shiny.html#create-a-sample-shiny-application"><i class="fa fa-check"></i><b>5.1.3</b> Create a sample shiny application</a></li>
<li class="chapter" data-level="5.1.4" data-path="session-5-shiny.html"><a href="session-5-shiny.html#shiny-architecture"><i class="fa fa-check"></i><b>5.1.4</b> Shiny architecture</a></li>
<li class="chapter" data-level="5.1.5" data-path="session-5-shiny.html"><a href="session-5-shiny.html#interactive-scatterplots"><i class="fa fa-check"></i><b>5.1.5</b> Interactive scatterplots</a></li>
<li class="chapter" data-level="5.1.6" data-path="session-5-shiny.html"><a href="session-5-shiny.html#extending-the-user-interface-with-dynamic-plots"><i class="fa fa-check"></i><b>5.1.6</b> Extending the user interface with dynamic plots</a></li>
<li class="chapter" data-level="5.1.7" data-path="session-5-shiny.html"><a href="session-5-shiny.html#finishing-touches-data-citation"><i class="fa fa-check"></i><b>5.1.7</b> Finishing touches: data citation</a></li>
<li class="chapter" data-level="5.1.8" data-path="session-5-shiny.html"><a href="session-5-shiny.html#publishing-shiny-applications"><i class="fa fa-check"></i><b>5.1.8</b> Publishing Shiny applications</a></li>
<li class="chapter" data-level="5.1.9" data-path="session-5-shiny.html"><a href="session-5-shiny.html#summary"><i class="fa fa-check"></i><b>5.1.9</b> Summary</a></li>
<li class="chapter" data-level="5.1.10" data-path="session-5-shiny.html"><a href="session-5-shiny.html#full-source-code-for-the-final-application"><i class="fa fa-check"></i><b>5.1.10</b> Full source code for the final application</a></li>
<li class="chapter" data-level="5.1.11" data-path="session-5-shiny.html"><a href="session-5-shiny.html#a-shinier-app-with-tabs-and-a-map"><i class="fa fa-check"></i><b>5.1.11</b> A shinier app with tabs and a map!</a></li>
<li class="chapter" data-level="5.1.12" data-path="session-5-shiny.html"><a href="session-5-shiny.html#resources"><i class="fa fa-check"></i><b>5.1.12</b> Resources</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="session-6-reproducible-workflows-revisited.html"><a href="session-6-reproducible-workflows-revisited.html"><i class="fa fa-check"></i><b>6</b> Session 6: Reproducible workflows revisited</a>
<ul>
<li class="chapter" data-level="6.1" data-path="session-6-reproducible-workflows-revisited.html"><a href="session-6-reproducible-workflows-revisited.html#workflows-and-continuous-integration"><i class="fa fa-check"></i><b>6.1</b> Workflows and Continuous Integration</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="session-6-reproducible-workflows-revisited.html"><a href="session-6-reproducible-workflows-revisited.html#learning-outcomes"><i class="fa fa-check"></i><b>6.1.1</b> Learning Outcomes</a></li>
<li class="chapter" data-level="6.1.2" data-path="session-6-reproducible-workflows-revisited.html"><a href="session-6-reproducible-workflows-revisited.html#introduction"><i class="fa fa-check"></i><b>6.1.2</b> Introduction</a></li>
<li class="chapter" data-level="6.1.3" data-path="session-6-reproducible-workflows-revisited.html"><a href="session-6-reproducible-workflows-revisited.html#workflow-dependencies-and-encapsulation"><i class="fa fa-check"></i><b>6.1.3</b> Workflow dependencies and encapsulation</a></li>
<li class="chapter" data-level="" data-path="session-6-reproducible-workflows-revisited.html"><a href="session-6-reproducible-workflows-revisited.html#dependencies"><i class="fa fa-check"></i>Dependencies</a></li>
<li class="chapter" data-level="6.1.4" data-path="session-6-reproducible-workflows-revisited.html"><a href="session-6-reproducible-workflows-revisited.html#benefits"><i class="fa fa-check"></i><b>6.1.4</b> Benefits</a></li>
<li class="chapter" data-level="6.1.5" data-path="session-6-reproducible-workflows-revisited.html"><a href="session-6-reproducible-workflows-revisited.html#organizing-code-in-packages"><i class="fa fa-check"></i><b>6.1.5</b> Organizing code in packages</a></li>
<li class="chapter" data-level="6.1.6" data-path="session-6-reproducible-workflows-revisited.html"><a href="session-6-reproducible-workflows-revisited.html#workflow-systems"><i class="fa fa-check"></i><b>6.1.6</b> Workflow systems</a></li>
<li class="chapter" data-level="6.1.7" data-path="session-6-reproducible-workflows-revisited.html"><a href="session-6-reproducible-workflows-revisited.html#exercise"><i class="fa fa-check"></i><b>6.1.7</b> Exercise</a></li>
<li class="chapter" data-level="6.1.8" data-path="session-6-reproducible-workflows-revisited.html"><a href="session-6-reproducible-workflows-revisited.html#readings-and-tutorials"><i class="fa fa-check"></i><b>6.1.8</b> Readings and tutorials</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="session-6-reproducible-workflows-revisited.html"><a href="session-6-reproducible-workflows-revisited.html#parallel-computing-in-r"><i class="fa fa-check"></i><b>6.2</b> Parallel Computing in R</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="session-6-reproducible-workflows-revisited.html"><a href="session-6-reproducible-workflows-revisited.html#learning-outcomes-1"><i class="fa fa-check"></i><b>6.2.1</b> Learning Outcomes</a></li>
<li class="chapter" data-level="6.2.2" data-path="session-6-reproducible-workflows-revisited.html"><a href="session-6-reproducible-workflows-revisited.html#introduction-1"><i class="fa fa-check"></i><b>6.2.2</b> Introduction</a></li>
<li class="chapter" data-level="6.2.3" data-path="session-6-reproducible-workflows-revisited.html"><a href="session-6-reproducible-workflows-revisited.html#why-parallelism"><i class="fa fa-check"></i><b>6.2.3</b> Why parallelism?</a></li>
<li class="chapter" data-level="6.2.4" data-path="session-6-reproducible-workflows-revisited.html"><a href="session-6-reproducible-workflows-revisited.html#processors-cpus-and-cores"><i class="fa fa-check"></i><b>6.2.4</b> Processors (CPUs) and Cores</a></li>
<li class="chapter" data-level="6.2.5" data-path="session-6-reproducible-workflows-revisited.html"><a href="session-6-reproducible-workflows-revisited.html#when-to-parallelize"><i class="fa fa-check"></i><b>6.2.5</b> When to parallelize</a></li>
<li class="chapter" data-level="6.2.6" data-path="session-6-reproducible-workflows-revisited.html"><a href="session-6-reproducible-workflows-revisited.html#loops-and-repetitive-tasks-using-lapply"><i class="fa fa-check"></i><b>6.2.6</b> Loops and repetitive tasks using lapply</a></li>
<li class="chapter" data-level="6.2.7" data-path="session-6-reproducible-workflows-revisited.html"><a href="session-6-reproducible-workflows-revisited.html#approaches-to-parallelization"><i class="fa fa-check"></i><b>6.2.7</b> Approaches to parallelization</a></li>
<li class="chapter" data-level="6.2.8" data-path="session-6-reproducible-workflows-revisited.html"><a href="session-6-reproducible-workflows-revisited.html#parallelize-using-mclapply"><i class="fa fa-check"></i><b>6.2.8</b> Parallelize using: mclapply</a></li>
<li class="chapter" data-level="6.2.9" data-path="session-6-reproducible-workflows-revisited.html"><a href="session-6-reproducible-workflows-revisited.html#parallelize-using-foreach-and-doparallel"><i class="fa fa-check"></i><b>6.2.9</b> Parallelize using: foreach and doParallel</a></li>
<li class="chapter" data-level="6.2.10" data-path="session-6-reproducible-workflows-revisited.html"><a href="session-6-reproducible-workflows-revisited.html#summary-1"><i class="fa fa-check"></i><b>6.2.10</b> Summary</a></li>
<li class="chapter" data-level="6.2.11" data-path="session-6-reproducible-workflows-revisited.html"><a href="session-6-reproducible-workflows-revisited.html#readings-and-tutorials-1"><i class="fa fa-check"></i><b>6.2.11</b> Readings and tutorials</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="session-7-communicating-your-research-the-message-box.html"><a href="session-7-communicating-your-research-the-message-box.html"><i class="fa fa-check"></i><b>7</b> Session 7: Communicating Your Research: The Message Box</a>
<ul>
<li class="chapter" data-level="7.1" data-path="session-7-communicating-your-research-the-message-box.html"><a href="session-7-communicating-your-research-the-message-box.html#communication-principles-and-practices"><i class="fa fa-check"></i><b>7.1</b> Communication Principles and Practices</a>
<ul>
<li class="chapter" data-level="7.1.1" data-path="session-7-communicating-your-research-the-message-box.html"><a href="session-7-communicating-your-research-the-message-box.html#scholarly-publications"><i class="fa fa-check"></i><b>7.1.1</b> Scholarly publications</a></li>
<li class="chapter" data-level="7.1.2" data-path="session-7-communicating-your-research-the-message-box.html"><a href="session-7-communicating-your-research-the-message-box.html#other-communications"><i class="fa fa-check"></i><b>7.1.2</b> Other communications</a></li>
<li class="chapter" data-level="7.1.3" data-path="session-7-communicating-your-research-the-message-box.html"><a href="session-7-communicating-your-research-the-message-box.html#the-message-box"><i class="fa fa-check"></i><b>7.1.3</b> The Message Box</a></li>
<li class="chapter" data-level="7.1.4" data-path="session-7-communicating-your-research-the-message-box.html"><a href="session-7-communicating-your-research-the-message-box.html#resources-1"><i class="fa fa-check"></i><b>7.1.4</b> Resources</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="session-8-wrap-up.html"><a href="session-8-wrap-up.html"><i class="fa fa-check"></i><b>8</b> Session 8: Wrap Up</a>
<ul>
<li class="chapter" data-level="8.1" data-path="session-8-wrap-up.html"><a href="session-8-wrap-up.html#session-wrap-up"><i class="fa fa-check"></i><b>8.1</b> Session Wrap Up</a>
<ul>
<li class="chapter" data-level="8.1.1" data-path="session-8-wrap-up.html"><a href="session-8-wrap-up.html#material-to-include"><i class="fa fa-check"></i><b>8.1.1</b> Material to include:</a></li>
</ul></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Open Science Synthesis for the Delta Science Program: Week 3</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="session-6-reproducible-workflows-revisited" class="section level1" number="6">
<h1><span class="header-section-number">6</span> Session 6: Reproducible workflows revisited</h1>
<div id="workflows-and-continuous-integration" class="section level2" number="6.1">
<h2><span class="header-section-number">6.1</span> Workflows and Continuous Integration</h2>
<div id="learning-outcomes" class="section level3" number="6.1.1">
<h3><span class="header-section-number">6.1.1</span> Learning Outcomes</h3>
<ul>
<li>Conceptualize workflows for reproducible processing</li>
<li>Understand how workflow systems can simplify repetitive tasks</li>
<li>Overview systems for executing workflows</li>
<li>Understand the utility of continuous integration</li>
</ul>
</div>
<div id="introduction" class="section level3" number="6.1.2">
<h3><span class="header-section-number">6.1.2</span> Introduction</h3>
<p>Preparing data for running analysis, models, and visualization processes can be complex,
with many dependencies among datasets, as well as complex needs for data cleaning,
munging, and integration that need to occur before “analysis” can begin.</p>
<p>Many research projects would benefit from a structured approach to organizing these
processes into workflows. A research workflow is an ordered sequence of steps in which the outputs
of one process are connected to the inputs of the next in a formal way. Steps are then
chained together to typically create a directed, acyclic graph that represents the
entire data processing pipeline.</p>
<p><img src="images/workflow.png" />
This hypothetical workflow shows three processing stages for downloading, integrating, and mapping the
data, along with the outputs of each step. This is a simplified rendition of what is normally a much more
complex process.</p>
<p>Whether simple or complex, it is helpful to conceptualize your entire workflow as a directed graph, which
helps to identify the explicit and implicit dependencies, and to plan work collaboratively.</p>
</div>
<div id="workflow-dependencies-and-encapsulation" class="section level3" number="6.1.3">
<h3><span class="header-section-number">6.1.3</span> Workflow dependencies and encapsulation</h3>
<p>While there are many thousands of details in any given analysis, the reason to create a workflow is to structure all of those details so that they are understandable and traceable. Being explicit about <strong>dependencies</strong> and building a <strong>hierarchical</strong> workflow that encapsulates the steps of the work as independent modules. So the idea is to focus the workflow on the <strong>major</strong> steps in the pipeline, and to articulate each of their dependencies.</p>
<p>Workflows can be implemented in many ways, with various benefits:</p>
<ul>
<li>as a conceptual diagram</li>
<li>As a series of functions that perform each step through a controlling script</li>
<li>As a series functions managed by a workflow tool like <a href="https://docs.ropensci.org/targets/"><code>targets</code></a></li>
<li>many others…</li>
</ul>
<p>Here’s a simple, toy example of using functions to encapsulate a workflow.</p>
<div class="sourceCode" id="cb246"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb246-1"><a href="session-6-reproducible-workflows-revisited.html#cb246-1" aria-hidden="true" tabindex="-1"></a>load_data <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb246-2"><a href="session-6-reproducible-workflows-revisited.html#cb246-2" aria-hidden="true" tabindex="-1"></a>    delta_taxa_file <span class="ot">&lt;-</span> contentid<span class="sc">::</span><span class="fu">resolve</span>(<span class="st">&quot;hash://sha256/1473de800f3c5577da077507fb006be816a9194ddd417b1b98836be92eaea49d&quot;</span>)</span>
<span id="cb246-3"><a href="session-6-reproducible-workflows-revisited.html#cb246-3" aria-hidden="true" tabindex="-1"></a>    delta_taxa <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(delta_taxa_file, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb246-4"><a href="session-6-reproducible-workflows-revisited.html#cb246-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">&quot;Data loading complete.&quot;</span>)</span>
<span id="cb246-5"><a href="session-6-reproducible-workflows-revisited.html#cb246-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(delta_taxa)</span>
<span id="cb246-6"><a href="session-6-reproducible-workflows-revisited.html#cb246-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb246-7"><a href="session-6-reproducible-workflows-revisited.html#cb246-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-8"><a href="session-6-reproducible-workflows-revisited.html#cb246-8" aria-hidden="true" tabindex="-1"></a>clean_data <span class="ot">&lt;-</span> <span class="cf">function</span>(delta_taxa) {</span>
<span id="cb246-9"><a href="session-6-reproducible-workflows-revisited.html#cb246-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">&quot;Data cleaning not implemented yet.&quot;</span>)</span>
<span id="cb246-10"><a href="session-6-reproducible-workflows-revisited.html#cb246-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb246-11"><a href="session-6-reproducible-workflows-revisited.html#cb246-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-12"><a href="session-6-reproducible-workflows-revisited.html#cb246-12" aria-hidden="true" tabindex="-1"></a>plot_data <span class="ot">&lt;-</span> <span class="cf">function</span>(delta_taxa) {</span>
<span id="cb246-13"><a href="session-6-reproducible-workflows-revisited.html#cb246-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">&quot;Plotting not implemented yet.&quot;</span>)</span>
<span id="cb246-14"><a href="session-6-reproducible-workflows-revisited.html#cb246-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb246-15"><a href="session-6-reproducible-workflows-revisited.html#cb246-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-16"><a href="session-6-reproducible-workflows-revisited.html#cb246-16" aria-hidden="true" tabindex="-1"></a>run_workflow <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb246-17"><a href="session-6-reproducible-workflows-revisited.html#cb246-17" aria-hidden="true" tabindex="-1"></a>    delta_taxa <span class="ot">&lt;-</span> <span class="fu">load_data</span>()</span>
<span id="cb246-18"><a href="session-6-reproducible-workflows-revisited.html#cb246-18" aria-hidden="true" tabindex="-1"></a>    delta_taxa_cleaned <span class="ot">&lt;-</span> <span class="fu">clean_data</span>(delta_taxa)</span>
<span id="cb246-19"><a href="session-6-reproducible-workflows-revisited.html#cb246-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot_data</span>(delta_taxa_cleaned)</span>
<span id="cb246-20"><a href="session-6-reproducible-workflows-revisited.html#cb246-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">&quot;Worflow run completed.&quot;</span>)</span>
<span id="cb246-21"><a href="session-6-reproducible-workflows-revisited.html#cb246-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb246-22"><a href="session-6-reproducible-workflows-revisited.html#cb246-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-23"><a href="session-6-reproducible-workflows-revisited.html#cb246-23" aria-hidden="true" tabindex="-1"></a><span class="fu">run_workflow</span>()</span></code></pre></div>
<pre><code>## [1] &quot;Data loading complete.&quot;
## [1] &quot;Data cleaning not implemented yet.&quot;
## [1] &quot;Plotting not implemented yet.&quot;
## [1] &quot;Worflow run completed.&quot;</code></pre>
<p>This workflow modularizes the code so that it is reasonably understandable, and it makes the dependencies among the steps clear. But we can do more. Each time the workflow is run, all of the functions are run. We could improve efficiency by only running the functions for which a dependencies changed.</p>
</div>
<div id="dependencies" class="section level3 unnumbered aside">
<h3>Dependencies</h3>
<p>Dependencies are the data and processes that must have completed before a given step in the workflow can be run. In purely functional programming, all of the dependencies would be passed as arguments to the function. This makes it so that the function is able to run with only the information that is passed to it at runtime, and is very powerful. However, dependendencies can also be provided by writing files to disk, or into a daatbase. These are called <em>side effects</em>, because a change in the state of the application was made (e.g., a file was changed), but there is no signal in the main function calls that this has happened. Many workflow systems are simply trying to make it easier to manage both direct dependencies and side-effects so that execution of a workflow can be executed cleanly.</p>
<div id="section" class="section level4 unnumbered">
<h4 class="unnumbered"></h4>
</div>
</div>
<div id="benefits" class="section level3" number="6.1.4">
<h3><span class="header-section-number">6.1.4</span> Benefits</h3>
<p>The benefits of conceptualizing work as a workflow include:</p>
<ul>
<li>Improved understanding</li>
<li>Efficiency</li>
<li>Automation</li>
<li>Improved quality via modular testing</li>
<li>Reproducibility</li>
</ul>
</div>
<div id="organizing-code-in-packages" class="section level3" number="6.1.5">
<h3><span class="header-section-number">6.1.5</span> Organizing code in packages</h3>
<p>Utilizing functions is key to good workflow design. We also need mechanisms to organize these functions so that they are accessible to a workflow executor. In the toy example above I put all of the functions in a single code block in a single function. While this works, it would get unwieldy in larger projects. While there are various ways to include code that is present in multiple files (e.g., using <code>source</code>), <a href="https://learning.nceas.ucsb.edu/2021-09-delta/session-7-functions-and-packages.html#creating-r-packages">R Packages</a> are specifically designed to make it easy to encapsulate work into different functions and files, and have those be accessible to all parts of the workflow. They also provide a great mechanism for describing the installation dependencies of your code. The basic structure of an R package is just a series of R code in files in the <code>R</code> subdirectory, with metadata about the package:</p>
<pre><code>.
├── DESCRIPTION
├── LICENSE.md
├── NAMESPACE
├── R
│   └── load_data.R
│   └── load_data_taxa.R
│   └── load_data_catch.R
│   └── clean_taxa.R
│   └── environment_info.R
├── man
│   └── environment_info.Rd
├── mytools.Rproj
└── tests
    ├── testthat
    │   └── test-enviroment_info.R
    └── testthat.R</code></pre>
</div>
<div id="workflow-systems" class="section level3" number="6.1.6">
<h3><span class="header-section-number">6.1.6</span> Workflow systems</h3>
<p>While managing workflows solely as linked functions works, the presence of side-effects in a workflow can make it more difficult to efficiently run only the parts of the workflow where items have changed. Workflow systems like Make and [<code>targets</code>] have been created to provide a structured way to specify, analyze, and track dependencies, and to execute only the parts of the workflow that are needed. For example, here’s an example workflow from <code>targets</code>:</p>
<p><img src="images/wf-targets-outdated.png" /></p>
<p>In this workflow, each icon represents a <em>target state</em> of the application, and it is the job of the workflow executor to make sure that all of these “targets” are up-to-date. The final products are dependent on both a pre-processed data pipeline, and on the code for generating a plot. In this example, the dark green icons indicate parts of the workflow that have not changed. Whereas the blue <code>create_plot</code> box indicates that the function has changed, which then “taints” all of the downstream parts of the workflow that depend on it. So, in this case, the change in <code>create_plot</code> means that the <code>hist</code> target must be re-executed, but the data processing pipeline above it does not currently need to be re-run.</p>
<p>Targets is configured by producing a special R script (<code>_targets.R</code>) that sets up the workflow to be executed. Here’s an example from the simple workflow example above:</p>
<div class="sourceCode" id="cb249"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb249-1"><a href="session-6-reproducible-workflows-revisited.html#cb249-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(targets)</span>
<span id="cb249-2"><a href="session-6-reproducible-workflows-revisited.html#cb249-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tarchetypes)</span>
<span id="cb249-3"><a href="session-6-reproducible-workflows-revisited.html#cb249-3" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">&quot;R/functions.R&quot;</span>)</span>
<span id="cb249-4"><a href="session-6-reproducible-workflows-revisited.html#cb249-4" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">tidyverse.quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb249-5"><a href="session-6-reproducible-workflows-revisited.html#cb249-5" aria-hidden="true" tabindex="-1"></a><span class="fu">tar_option_set</span>(<span class="at">packages =</span> <span class="fu">c</span>(<span class="st">&quot;biglm&quot;</span>, <span class="st">&quot;dplyr&quot;</span>, <span class="st">&quot;ggplot2&quot;</span>, <span class="st">&quot;readr&quot;</span>, <span class="st">&quot;tidyr&quot;</span>))</span>
<span id="cb249-6"><a href="session-6-reproducible-workflows-revisited.html#cb249-6" aria-hidden="true" tabindex="-1"></a><span class="fu">list</span>(</span>
<span id="cb249-7"><a href="session-6-reproducible-workflows-revisited.html#cb249-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tar_target</span>(</span>
<span id="cb249-8"><a href="session-6-reproducible-workflows-revisited.html#cb249-8" aria-hidden="true" tabindex="-1"></a>    raw_data_file,</span>
<span id="cb249-9"><a href="session-6-reproducible-workflows-revisited.html#cb249-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;data/raw_data.csv&quot;</span>,</span>
<span id="cb249-10"><a href="session-6-reproducible-workflows-revisited.html#cb249-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">format =</span> <span class="st">&quot;file&quot;</span></span>
<span id="cb249-11"><a href="session-6-reproducible-workflows-revisited.html#cb249-11" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb249-12"><a href="session-6-reproducible-workflows-revisited.html#cb249-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tar_target</span>(</span>
<span id="cb249-13"><a href="session-6-reproducible-workflows-revisited.html#cb249-13" aria-hidden="true" tabindex="-1"></a>    raw_data,</span>
<span id="cb249-14"><a href="session-6-reproducible-workflows-revisited.html#cb249-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">read_csv</span>(raw_data_file, <span class="at">col_types =</span> <span class="fu">cols</span>())</span>
<span id="cb249-15"><a href="session-6-reproducible-workflows-revisited.html#cb249-15" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb249-16"><a href="session-6-reproducible-workflows-revisited.html#cb249-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tar_target</span>(</span>
<span id="cb249-17"><a href="session-6-reproducible-workflows-revisited.html#cb249-17" aria-hidden="true" tabindex="-1"></a>    data,</span>
<span id="cb249-18"><a href="session-6-reproducible-workflows-revisited.html#cb249-18" aria-hidden="true" tabindex="-1"></a>    raw_data <span class="sc">%&gt;%</span></span>
<span id="cb249-19"><a href="session-6-reproducible-workflows-revisited.html#cb249-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Ozone))</span>
<span id="cb249-20"><a href="session-6-reproducible-workflows-revisited.html#cb249-20" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb249-21"><a href="session-6-reproducible-workflows-revisited.html#cb249-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tar_target</span>(hist, <span class="fu">create_plot</span>(data)),</span>
<span id="cb249-22"><a href="session-6-reproducible-workflows-revisited.html#cb249-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tar_target</span>(fit, <span class="fu">biglm</span>(Ozone <span class="sc">~</span> Wind <span class="sc">+</span> Temp, data)),</span>
<span id="cb249-23"><a href="session-6-reproducible-workflows-revisited.html#cb249-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tar_render</span>(report, <span class="st">&quot;index.Rmd&quot;</span>)</span>
<span id="cb249-24"><a href="session-6-reproducible-workflows-revisited.html#cb249-24" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>This is really useful for being able to incrementally work through data loading and cleaning pipelines that feed downstream analytical functions that depend on using a consistent set of input data.</p>
</div>
<div id="exercise" class="section level3" number="6.1.7">
<h3><span class="header-section-number">6.1.7</span> Exercise</h3>
<p>Take an analysis that you are familiar with, and:</p>
<ul>
<li>draw a diagram of the major steps and substeps of the workflow</li>
<li>analyze the dependencies of these steps and substeps</li>
<li>stub out a set of functions that would execute that workflow</li>
</ul>
</div>
<div id="readings-and-tutorials" class="section level3" number="6.1.8">
<h3><span class="header-section-number">6.1.8</span> Readings and tutorials</h3>
<ul>
<li>The <a href="https://docs.ropensci.org/targets/"><code>targets</code></a> package</li>
</ul>
</div>
</div>
<div id="parallel-computing-in-r" class="section level2" number="6.2">
<h2><span class="header-section-number">6.2</span> Parallel Computing in R</h2>
<div id="learning-outcomes-1" class="section level3" number="6.2.1">
<h3><span class="header-section-number">6.2.1</span> Learning Outcomes</h3>
<ul>
<li>Understand what parallel computing is and when it may be useful</li>
<li>Understand how parallelism can work</li>
<li>Review sequential loops and *apply functions</li>
<li>Understand and use the <code>parallel</code> package multicore functions</li>
<li>Understand and use the <code>foreach</code> package functions</li>
</ul>
</div>
<div id="introduction-1" class="section level3" number="6.2.2">
<h3><span class="header-section-number">6.2.2</span> Introduction</h3>
<p>Processing large amounts of data with complex models can be time consuming. New types of sensing means the scale of data collection today is massive. And modeled outputs can be large as well. For example, here’s a 2 TB (that’s Terabyte) set of modeled output data from <a href="https://doi.org/10.5063/F1Z899CZ">Ofir Levy et al. 2016</a> that models 15 environmental variables at hourly time scales for hundreds of years across a regular grid spanning a good chunk of North America:</p>
<div class="figure">
<img src="images/levy-map.png" alt="" />
<p class="caption">Levy et al. 2016. <a href="doi:10.5063/F1Z899CZ" class="uri">doi:10.5063/F1Z899CZ</a></p>
</div>
<p>There are over 400,000 individual netCDF files in the <a href="https://doi.org/10.5063/F1Z899CZ">Levy et al. microclimate data set</a>. Processing them would benefit massively from parallelization.</p>
<p>Alternatively, think of remote sensing data. Processing airborne hyperspectral data can involve processing each of hundreds of bands of data for each image in a flight path that is repeated many times over months and years.</p>
<div class="figure">
<img src="images/DataCube.png" alt="" />
<p class="caption">NEON Data Cube</p>
</div>
</div>
<div id="why-parallelism" class="section level3" number="6.2.3">
<h3><span class="header-section-number">6.2.3</span> Why parallelism?</h3>
<p>Much R code runs fast and fine on a single processor. But at times, computations
can be:</p>
<ul>
<li><strong>cpu-bound</strong>: Take too much cpu time</li>
<li><strong>memory-bound</strong>: Take too much memory</li>
<li><strong>I/O-bound</strong>: Take too much time to read/write from disk</li>
<li><strong>network-bound</strong>: Take too much time to transfer</li>
</ul>
<p>To help with <strong>cpu-bound</strong> computations, one can take advantage of modern processor architectures that provide multiple cores on a single processor, and thereby enable multiple computations to take place at the same time. In addition, some machines ship with multiple processors, allowing large computations to occur across the entire cluster of those computers. Plus, these machines also have large amounts of memory to avoid <strong>memory-bound</strong> computing jobs.</p>
</div>
<div id="processors-cpus-and-cores" class="section level3" number="6.2.4">
<h3><span class="header-section-number">6.2.4</span> Processors (CPUs) and Cores</h3>
<p>A modern CPU (Central Processing Unit) is at the heart of every computer. While
traditional computers had a single CPU, modern computers can ship with mutliple
processors, which in turn can each contain multiple cores. These processors and
cores are available to perform computations.</p>
<p>A computer with one processor may still have 4 cores (quad-core), allowing 4 computations
to be executed at the same time.</p>
<p><img src="images/processor.png" /></p>
<p>A typical modern computer has multiple cores, ranging from one or two in laptops
to thousands in high performance compute clusters. Here we show four quad-core
processors for a total of 16 cores in this machine.</p>
<p><img src="images/processors.png" /></p>
<p>You can think of this as allowing 16 computations to happen at the same time. Theroetically, your computation would take 1/16 of the time (but only theoretically, more on that later).</p>
<p>Historically, R has only utilized one processor, which makes it single-threaded. Which is a shame, because the 2017 MacBook Pro that I am writing this on is much more powerful than that:</p>
<div class="sourceCode" id="cb250"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb250-1"><a href="session-6-reproducible-workflows-revisited.html#cb250-1" aria-hidden="true" tabindex="-1"></a><span class="ex">jones@powder:~$</span> sysctl hw.ncpu hw.physicalcpu</span>
<span id="cb250-2"><a href="session-6-reproducible-workflows-revisited.html#cb250-2" aria-hidden="true" tabindex="-1"></a><span class="ex">hw.ncpu:</span> 8</span>
<span id="cb250-3"><a href="session-6-reproducible-workflows-revisited.html#cb250-3" aria-hidden="true" tabindex="-1"></a><span class="ex">hw.physicalcpu:</span> 4</span></code></pre></div>
<p>To interpret that output, this machine <code>powder</code> has 4 physical CPUs, each of which has
two processing cores, for a total of 8 cores for computation. I’d sure like my R computations to use all of that processing power. Because its all on one machine, we can easily use <em>multicore</em> processing tools to make use of those cores. Now let’s look at
the computational server <code>aurora</code> at NCEAS:</p>
<div class="sourceCode" id="cb251"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb251-1"><a href="session-6-reproducible-workflows-revisited.html#cb251-1" aria-hidden="true" tabindex="-1"></a><span class="ex">jones@aurora:~$</span> lscpu <span class="kw">|</span> <span class="fu">egrep</span> <span class="st">&#39;CPU\(s\)|per core|per socket&#39;</span></span>
<span id="cb251-2"><a href="session-6-reproducible-workflows-revisited.html#cb251-2" aria-hidden="true" tabindex="-1"></a><span class="ex">CPU</span><span class="er">(</span><span class="ex">s</span><span class="kw">)</span><span class="bu">:</span>                88</span>
<span id="cb251-3"><a href="session-6-reproducible-workflows-revisited.html#cb251-3" aria-hidden="true" tabindex="-1"></a><span class="ex">On-line</span> CPU<span class="er">(</span><span class="ex">s</span><span class="kw">)</span> <span class="ex">list:</span>   0-87</span>
<span id="cb251-4"><a href="session-6-reproducible-workflows-revisited.html#cb251-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Thread</span><span class="er">(</span><span class="ex">s</span><span class="kw">)</span> <span class="ex">per</span> core:    2</span>
<span id="cb251-5"><a href="session-6-reproducible-workflows-revisited.html#cb251-5" aria-hidden="true" tabindex="-1"></a><span class="ex">Core</span><span class="er">(</span><span class="ex">s</span><span class="kw">)</span> <span class="ex">per</span> socket:    22</span>
<span id="cb251-6"><a href="session-6-reproducible-workflows-revisited.html#cb251-6" aria-hidden="true" tabindex="-1"></a><span class="ex">NUMA</span> node0 CPU<span class="er">(</span><span class="ex">s</span><span class="kw">)</span><span class="bu">:</span>     0,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30,32,34,36,38,40,42,44,46,48,50,52,54,56,58,60,62,64,66,68,70,72,74,76,78,80,82,84,86</span>
<span id="cb251-7"><a href="session-6-reproducible-workflows-revisited.html#cb251-7" aria-hidden="true" tabindex="-1"></a><span class="ex">NUMA</span> node1 CPU<span class="er">(</span><span class="ex">s</span><span class="kw">)</span><span class="bu">:</span>     1,3,5,7,9,11,13,15,17,19,21,23,25,27,29,31,33,35,37,39,41,43,45,47,49,51,53,55,57,59,61,63,65,67,69,71,73,75,77,79,81,83,85,87</span></code></pre></div>
<p>Now that’s some compute power! Aurora has 384 GB of RAM, and ample storage. All still under the control of a single operating system.</p>
<p>However, maybe one of these NSF-sponsored high performance computing clusters (HPC) is looking attractive about now:</p>
<ul>
<li><a href="https://jetstream-cloud.org/">JetStream</a>
<ul>
<li>640 nodes, 15,360 cores, 80TB RAM</li>
</ul></li>
<li><a href="">Stampede2</a> at TACC is coming online in 2017
<ul>
<li>4200 nodes, 285,600 cores</li>
</ul></li>
</ul>
<p>Note that these clusters have multiple nodes (hosts), and each host has multiple cores. So this is really multiple computers clustered together to act in a coordinated fashion, but each node runs its own copy of the operating system, and is in many ways independent of the other nodes in the cluster. One way to use such a cluster would be to use just one of the nodes, and use a multi-core approach to parallelization to use all of the cores on that single machine. But to truly make use of the whole cluster, one must use parallelization tools that let us spread out our computations across multiple host nodes in the cluster.</p>
</div>
<div id="when-to-parallelize" class="section level3" number="6.2.5">
<h3><span class="header-section-number">6.2.5</span> When to parallelize</h3>
<p>It’s not as simple as it may seem. While in theory each added processor would linearly increase the throughput of a computation, there is overhead that reduces that efficiency. For example, the code and, importantly, the data need to be copied to each additional CPU, and this takes time and bandwidth. Plus, new processes and/or threads need to be created by the operating system, which also takes time. This overhead reduces the efficiency enough that realistic performance gains are much less than theoretical, and usually do not scale linearly as a function of processing power. For example, if the time that a computation takes is short, then the overhead of setting up these additional resources may actually overwhelm any advantages of the additional processing power, and the computation could potentially take longer!</p>
<p>In addition, not all of a task can be parallelized. Depending on the proportion, the expected speedup can be significantly reduced. Some propose that this may follow <a href="https://en.wikipedia.org/wiki/Amdahl%27s_law">Amdahl’s Law</a>, where the speedup of the computation (y-axis) is a function of both the number of cores (x-axis) and the proportion of the computation that can be parallelized (see colored lines):</p>
<p><img src="reproducible-research-short-course_files/figure-html/amdahl-1.png" width="672" /></p>
<p>So, its important to evaluate the computational efficiency of requests, and work to ensure that additional compute resources brought to bear will pay off in terms of increased work being done. With that, let’s do some parallel computing…</p>
</div>
<div id="loops-and-repetitive-tasks-using-lapply" class="section level3" number="6.2.6">
<h3><span class="header-section-number">6.2.6</span> Loops and repetitive tasks using lapply</h3>
<p>When you have a list of repetitive tasks, you may be able to speed it up by adding more computing power. If each task is completely independent of the others, then it is a prime candidate for executing those tasks in parallel, each on its own core. For example, let’s build a simple loop that uses sample with replacement to do a bootstrap analysis. In this case, we select <code>Sepal.Length</code> and <code>Species</code> from the <code>iris</code> dataset, subset it to 100 observations, and then iterate across 10,000 trials, each time resampling the observations with replacement. We then run a logistic regression fitting species as a function of length, and record the coefficients for each trial to be returned.</p>
<div class="sourceCode" id="cb252"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb252-1"><a href="session-6-reproducible-workflows-revisited.html#cb252-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> iris[<span class="fu">which</span>(iris[,<span class="dv">5</span>] <span class="sc">!=</span> <span class="st">&quot;setosa&quot;</span>), <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">5</span>)]</span>
<span id="cb252-2"><a href="session-6-reproducible-workflows-revisited.html#cb252-2" aria-hidden="true" tabindex="-1"></a>trials <span class="ot">&lt;-</span> <span class="dv">10000</span></span>
<span id="cb252-3"><a href="session-6-reproducible-workflows-revisited.html#cb252-3" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb252-4"><a href="session-6-reproducible-workflows-revisited.html#cb252-4" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb252-5"><a href="session-6-reproducible-workflows-revisited.html#cb252-5" aria-hidden="true" tabindex="-1"></a>  trial <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb252-6"><a href="session-6-reproducible-workflows-revisited.html#cb252-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span>(trial <span class="sc">&lt;=</span> trials) {</span>
<span id="cb252-7"><a href="session-6-reproducible-workflows-revisited.html#cb252-7" aria-hidden="true" tabindex="-1"></a>    ind <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">100</span>, <span class="dv">100</span>, <span class="at">replace=</span><span class="cn">TRUE</span>)</span>
<span id="cb252-8"><a href="session-6-reproducible-workflows-revisited.html#cb252-8" aria-hidden="true" tabindex="-1"></a>    result1 <span class="ot">&lt;-</span> <span class="fu">glm</span>(x[ind,<span class="dv">2</span>]<span class="sc">~</span>x[ind,<span class="dv">1</span>], <span class="at">family=</span><span class="fu">binomial</span>(logit))</span>
<span id="cb252-9"><a href="session-6-reproducible-workflows-revisited.html#cb252-9" aria-hidden="true" tabindex="-1"></a>    r <span class="ot">&lt;-</span> <span class="fu">coefficients</span>(result1)</span>
<span id="cb252-10"><a href="session-6-reproducible-workflows-revisited.html#cb252-10" aria-hidden="true" tabindex="-1"></a>    res <span class="ot">&lt;-</span> <span class="fu">rbind</span>(res, r)</span>
<span id="cb252-11"><a href="session-6-reproducible-workflows-revisited.html#cb252-11" aria-hidden="true" tabindex="-1"></a>    trial <span class="ot">&lt;-</span> trial <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb252-12"><a href="session-6-reproducible-workflows-revisited.html#cb252-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb252-13"><a href="session-6-reproducible-workflows-revisited.html#cb252-13" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   25.61    1.86   28.21</code></pre>
<p>The issue with this loop is that we execute each trial sequentially, which means that only one of our 8 processors on this machine are in use. In order to exploit parallelism, we need to be able to dispatch our tasks as functions, with one task
going to each processor. To do that, we need to convert our task to a function, and then use the <code>*apply()</code> family of R functions to apply that function to all of the members of a set. In R, using <code>apply</code> used to be faster than the equivalent code in a loop, but now they are similar due to optimizations in R loop handling. However, using the function allows us to later take advantage of other approaches to parallelization. Here’s the same code rewritten to use <code>lapply()</code>, which applies a function to each of the members of a list (in this case the trials we want to run):</p>
<div class="sourceCode" id="cb254"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb254-1"><a href="session-6-reproducible-workflows-revisited.html#cb254-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> iris[<span class="fu">which</span>(iris[,<span class="dv">5</span>] <span class="sc">!=</span> <span class="st">&quot;setosa&quot;</span>), <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">5</span>)]</span>
<span id="cb254-2"><a href="session-6-reproducible-workflows-revisited.html#cb254-2" aria-hidden="true" tabindex="-1"></a>trials <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">10000</span>)</span>
<span id="cb254-3"><a href="session-6-reproducible-workflows-revisited.html#cb254-3" aria-hidden="true" tabindex="-1"></a>boot_fx <span class="ot">&lt;-</span> <span class="cf">function</span>(trial) {</span>
<span id="cb254-4"><a href="session-6-reproducible-workflows-revisited.html#cb254-4" aria-hidden="true" tabindex="-1"></a>  ind <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">100</span>, <span class="dv">100</span>, <span class="at">replace=</span><span class="cn">TRUE</span>)</span>
<span id="cb254-5"><a href="session-6-reproducible-workflows-revisited.html#cb254-5" aria-hidden="true" tabindex="-1"></a>  result1 <span class="ot">&lt;-</span> <span class="fu">glm</span>(x[ind,<span class="dv">2</span>]<span class="sc">~</span>x[ind,<span class="dv">1</span>], <span class="at">family=</span><span class="fu">binomial</span>(logit))</span>
<span id="cb254-6"><a href="session-6-reproducible-workflows-revisited.html#cb254-6" aria-hidden="true" tabindex="-1"></a>  r <span class="ot">&lt;-</span> <span class="fu">coefficients</span>(result1)</span>
<span id="cb254-7"><a href="session-6-reproducible-workflows-revisited.html#cb254-7" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">data.frame</span>(), r)</span>
<span id="cb254-8"><a href="session-6-reproducible-workflows-revisited.html#cb254-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb254-9"><a href="session-6-reproducible-workflows-revisited.html#cb254-9" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb254-10"><a href="session-6-reproducible-workflows-revisited.html#cb254-10" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(trials, boot_fx)</span>
<span id="cb254-11"><a href="session-6-reproducible-workflows-revisited.html#cb254-11" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>##    user  system elapsed 
##  28.259   0.777  29.428</code></pre>
</div>
<div id="approaches-to-parallelization" class="section level3" number="6.2.7">
<h3><span class="header-section-number">6.2.7</span> Approaches to parallelization</h3>
<p>When parallelizing jobs, one can:</p>
<ul>
<li><p>Use the multiple cores on a local computer through <code>mclapply</code></p></li>
<li><p>Use multiple processors on local (and remote) machines using <code>makeCluster</code> and <code>clusterApply</code></p>
<ul>
<li>In this approach, one has to manually copy data and code to each cluster member using <code>clusterExport</code></li>
<li>This is extra work, but sometimes gaining access to a large cluster is worth it</li>
</ul></li>
</ul>
</div>
<div id="parallelize-using-mclapply" class="section level3" number="6.2.8">
<h3><span class="header-section-number">6.2.8</span> Parallelize using: mclapply</h3>
<p>The <code>parallel</code> library can be used to send tasks (encoded as function calls) to each of the processing cores on your machine in parallel. This is done by using the <code>parallel::mclapply</code> function, which is analogous to <code>lapply</code>, but distributes the tasks to multiple processors. <code>mclapply</code> gathers up the responses from each of these function calls, and returns a list of responses that is the same length as the list or vector of input data (one return per input item).</p>
<div class="sourceCode" id="cb256"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb256-1"><a href="session-6-reproducible-workflows-revisited.html#cb256-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(parallel)</span>
<span id="cb256-2"><a href="session-6-reproducible-workflows-revisited.html#cb256-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MASS)</span></code></pre></div>
<pre><code>## 
## Attaching package: &#39;MASS&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:dplyr&#39;:
## 
##     select</code></pre>
<div class="sourceCode" id="cb259"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb259-1"><a href="session-6-reproducible-workflows-revisited.html#cb259-1" aria-hidden="true" tabindex="-1"></a>starts <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">100</span>, <span class="dv">40</span>)</span>
<span id="cb259-2"><a href="session-6-reproducible-workflows-revisited.html#cb259-2" aria-hidden="true" tabindex="-1"></a>fx <span class="ot">&lt;-</span> <span class="cf">function</span>(nstart) <span class="fu">kmeans</span>(Boston, <span class="dv">4</span>, <span class="at">nstart=</span>nstart)</span>
<span id="cb259-3"><a href="session-6-reproducible-workflows-revisited.html#cb259-3" aria-hidden="true" tabindex="-1"></a>numCores <span class="ot">&lt;-</span> <span class="fu">detectCores</span>()</span>
<span id="cb259-4"><a href="session-6-reproducible-workflows-revisited.html#cb259-4" aria-hidden="true" tabindex="-1"></a>numCores</span></code></pre></div>
<pre><code>## [1] 3</code></pre>
<div class="sourceCode" id="cb261"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb261-1"><a href="session-6-reproducible-workflows-revisited.html#cb261-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(</span>
<span id="cb261-2"><a href="session-6-reproducible-workflows-revisited.html#cb261-2" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(starts, fx)</span>
<span id="cb261-3"><a href="session-6-reproducible-workflows-revisited.html#cb261-3" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   1.327   0.128   1.462</code></pre>
<div class="sourceCode" id="cb263"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb263-1"><a href="session-6-reproducible-workflows-revisited.html#cb263-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(</span>
<span id="cb263-2"><a href="session-6-reproducible-workflows-revisited.html#cb263-2" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">mclapply</span>(starts, fx, <span class="at">mc.cores =</span> numCores)</span>
<span id="cb263-3"><a href="session-6-reproducible-workflows-revisited.html#cb263-3" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.926   0.277   0.748</code></pre>
<p>Now let’s demonstrate with our bootstrap example:</p>
<div class="sourceCode" id="cb265"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb265-1"><a href="session-6-reproducible-workflows-revisited.html#cb265-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> iris[<span class="fu">which</span>(iris[,<span class="dv">5</span>] <span class="sc">!=</span> <span class="st">&quot;setosa&quot;</span>), <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">5</span>)]</span>
<span id="cb265-2"><a href="session-6-reproducible-workflows-revisited.html#cb265-2" aria-hidden="true" tabindex="-1"></a>trials <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">10000</span>)</span>
<span id="cb265-3"><a href="session-6-reproducible-workflows-revisited.html#cb265-3" aria-hidden="true" tabindex="-1"></a>boot_fx <span class="ot">&lt;-</span> <span class="cf">function</span>(trial) {</span>
<span id="cb265-4"><a href="session-6-reproducible-workflows-revisited.html#cb265-4" aria-hidden="true" tabindex="-1"></a>  ind <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">100</span>, <span class="dv">100</span>, <span class="at">replace=</span><span class="cn">TRUE</span>)</span>
<span id="cb265-5"><a href="session-6-reproducible-workflows-revisited.html#cb265-5" aria-hidden="true" tabindex="-1"></a>  result1 <span class="ot">&lt;-</span> <span class="fu">glm</span>(x[ind,<span class="dv">2</span>]<span class="sc">~</span>x[ind,<span class="dv">1</span>], <span class="at">family=</span><span class="fu">binomial</span>(logit))</span>
<span id="cb265-6"><a href="session-6-reproducible-workflows-revisited.html#cb265-6" aria-hidden="true" tabindex="-1"></a>  r <span class="ot">&lt;-</span> <span class="fu">coefficients</span>(result1)</span>
<span id="cb265-7"><a href="session-6-reproducible-workflows-revisited.html#cb265-7" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">data.frame</span>(), r)</span>
<span id="cb265-8"><a href="session-6-reproducible-workflows-revisited.html#cb265-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb265-9"><a href="session-6-reproducible-workflows-revisited.html#cb265-9" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb265-10"><a href="session-6-reproducible-workflows-revisited.html#cb265-10" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">mclapply</span>(trials, boot_fx, <span class="at">mc.cores =</span> numCores)</span>
<span id="cb265-11"><a href="session-6-reproducible-workflows-revisited.html#cb265-11" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   9.633   0.678  12.593</code></pre>
</div>
<div id="parallelize-using-foreach-and-doparallel" class="section level3" number="6.2.9">
<h3><span class="header-section-number">6.2.9</span> Parallelize using: foreach and doParallel</h3>
<p>The normal <code>for</code> loop in R looks like:</p>
<div class="sourceCode" id="cb267"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb267-1"><a href="session-6-reproducible-workflows-revisited.html#cb267-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>) {</span>
<span id="cb267-2"><a href="session-6-reproducible-workflows-revisited.html#cb267-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">sqrt</span>(i))</span>
<span id="cb267-3"><a href="session-6-reproducible-workflows-revisited.html#cb267-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## [1] 1
## [1] 1.41
## [1] 1.73</code></pre>
<p>The <code>foreach</code> method is similar, but uses the sequential <code>%do%</code> operator to indicate an expression to run. Note the difference in the returned data structure.</p>
<div class="sourceCode" id="cb269"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb269-1"><a href="session-6-reproducible-workflows-revisited.html#cb269-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(foreach)</span>
<span id="cb269-2"><a href="session-6-reproducible-workflows-revisited.html#cb269-2" aria-hidden="true" tabindex="-1"></a><span class="fu">foreach</span> (<span class="at">i=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>) <span class="sc">%do%</span> {</span>
<span id="cb269-3"><a href="session-6-reproducible-workflows-revisited.html#cb269-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sqrt</span>(i)</span>
<span id="cb269-4"><a href="session-6-reproducible-workflows-revisited.html#cb269-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## [[1]]
## [1] 1
## 
## [[2]]
## [1] 1.41
## 
## [[3]]
## [1] 1.73</code></pre>
<p>In addition, <code>foreach</code> supports a parallelizable operator <code>%dopar%</code> from the <code>doParallel</code> package. This allows each iteration through the loop to use different cores or different machines in a cluster. Here, we demonstrate with using all the cores on the current machine:</p>
<div class="sourceCode" id="cb271"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb271-1"><a href="session-6-reproducible-workflows-revisited.html#cb271-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(foreach)</span>
<span id="cb271-2"><a href="session-6-reproducible-workflows-revisited.html#cb271-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(doParallel)</span></code></pre></div>
<pre><code>## Loading required package: iterators</code></pre>
<div class="sourceCode" id="cb273"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb273-1"><a href="session-6-reproducible-workflows-revisited.html#cb273-1" aria-hidden="true" tabindex="-1"></a><span class="fu">registerDoParallel</span>(numCores)  <span class="co"># use multicore, set to the number of our cores</span></span>
<span id="cb273-2"><a href="session-6-reproducible-workflows-revisited.html#cb273-2" aria-hidden="true" tabindex="-1"></a><span class="fu">foreach</span> (<span class="at">i=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>) <span class="sc">%dopar%</span> {</span>
<span id="cb273-3"><a href="session-6-reproducible-workflows-revisited.html#cb273-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sqrt</span>(i)</span>
<span id="cb273-4"><a href="session-6-reproducible-workflows-revisited.html#cb273-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## [[1]]
## [1] 1
## 
## [[2]]
## [1] 1.41
## 
## [[3]]
## [1] 1.73</code></pre>
<div class="sourceCode" id="cb275"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb275-1"><a href="session-6-reproducible-workflows-revisited.html#cb275-1" aria-hidden="true" tabindex="-1"></a><span class="co"># To simplify output, foreach has the .combine parameter that can simplify return values</span></span>
<span id="cb275-2"><a href="session-6-reproducible-workflows-revisited.html#cb275-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb275-3"><a href="session-6-reproducible-workflows-revisited.html#cb275-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Return a vector</span></span>
<span id="cb275-4"><a href="session-6-reproducible-workflows-revisited.html#cb275-4" aria-hidden="true" tabindex="-1"></a><span class="fu">foreach</span> (<span class="at">i=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">.combine=</span>c) <span class="sc">%dopar%</span> {</span>
<span id="cb275-5"><a href="session-6-reproducible-workflows-revisited.html#cb275-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sqrt</span>(i)</span>
<span id="cb275-6"><a href="session-6-reproducible-workflows-revisited.html#cb275-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>## [1] 1.00 1.41 1.73</code></pre>
<div class="sourceCode" id="cb277"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb277-1"><a href="session-6-reproducible-workflows-revisited.html#cb277-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Return a data frame</span></span>
<span id="cb277-2"><a href="session-6-reproducible-workflows-revisited.html#cb277-2" aria-hidden="true" tabindex="-1"></a><span class="fu">foreach</span> (<span class="at">i=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">.combine=</span>rbind) <span class="sc">%dopar%</span> {</span>
<span id="cb277-3"><a href="session-6-reproducible-workflows-revisited.html#cb277-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sqrt</span>(i)</span>
<span id="cb277-4"><a href="session-6-reproducible-workflows-revisited.html#cb277-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<pre><code>##          [,1]
## result.1 1.00
## result.2 1.41
## result.3 1.73</code></pre>
<p>The <a href="https://cran.r-project.org/web/packages/doParallel/vignettes/gettingstartedParallel.pdf">doParallel vignette</a> on CRAN shows a much more realistic example, where one can use `%dopar% to parallelize a bootstrap analysis where a data set is resampled 10,000 times and the analysis is rerun on each sample, and then the results combined:</p>
<div class="sourceCode" id="cb279"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb279-1"><a href="session-6-reproducible-workflows-revisited.html#cb279-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Let&#39;s use the iris data set to do a parallel bootstrap</span></span>
<span id="cb279-2"><a href="session-6-reproducible-workflows-revisited.html#cb279-2" aria-hidden="true" tabindex="-1"></a><span class="co"># From the doParallel vignette, but slightly modified</span></span>
<span id="cb279-3"><a href="session-6-reproducible-workflows-revisited.html#cb279-3" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> iris[<span class="fu">which</span>(iris[,<span class="dv">5</span>] <span class="sc">!=</span> <span class="st">&quot;setosa&quot;</span>), <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">5</span>)]</span>
<span id="cb279-4"><a href="session-6-reproducible-workflows-revisited.html#cb279-4" aria-hidden="true" tabindex="-1"></a>trials <span class="ot">&lt;-</span> <span class="dv">10000</span></span>
<span id="cb279-5"><a href="session-6-reproducible-workflows-revisited.html#cb279-5" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb279-6"><a href="session-6-reproducible-workflows-revisited.html#cb279-6" aria-hidden="true" tabindex="-1"></a>  r <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="fu">icount</span>(trials), <span class="at">.combine=</span>rbind) <span class="sc">%dopar%</span> {</span>
<span id="cb279-7"><a href="session-6-reproducible-workflows-revisited.html#cb279-7" aria-hidden="true" tabindex="-1"></a>    ind <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">100</span>, <span class="dv">100</span>, <span class="at">replace=</span><span class="cn">TRUE</span>)</span>
<span id="cb279-8"><a href="session-6-reproducible-workflows-revisited.html#cb279-8" aria-hidden="true" tabindex="-1"></a>    result1 <span class="ot">&lt;-</span> <span class="fu">glm</span>(x[ind,<span class="dv">2</span>]<span class="sc">~</span>x[ind,<span class="dv">1</span>], <span class="at">family=</span><span class="fu">binomial</span>(logit))</span>
<span id="cb279-9"><a href="session-6-reproducible-workflows-revisited.html#cb279-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coefficients</span>(result1)</span>
<span id="cb279-10"><a href="session-6-reproducible-workflows-revisited.html#cb279-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb279-11"><a href="session-6-reproducible-workflows-revisited.html#cb279-11" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>##    user  system elapsed 
##   25.74    2.07   12.20</code></pre>
<div class="sourceCode" id="cb281"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb281-1"><a href="session-6-reproducible-workflows-revisited.html#cb281-1" aria-hidden="true" tabindex="-1"></a><span class="co"># And compare that to what it takes to do the same analysis in serial</span></span>
<span id="cb281-2"><a href="session-6-reproducible-workflows-revisited.html#cb281-2" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb281-3"><a href="session-6-reproducible-workflows-revisited.html#cb281-3" aria-hidden="true" tabindex="-1"></a>  r <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="fu">icount</span>(trials), <span class="at">.combine=</span>rbind) <span class="sc">%do%</span> {</span>
<span id="cb281-4"><a href="session-6-reproducible-workflows-revisited.html#cb281-4" aria-hidden="true" tabindex="-1"></a>    ind <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">100</span>, <span class="dv">100</span>, <span class="at">replace=</span><span class="cn">TRUE</span>)</span>
<span id="cb281-5"><a href="session-6-reproducible-workflows-revisited.html#cb281-5" aria-hidden="true" tabindex="-1"></a>    result1 <span class="ot">&lt;-</span> <span class="fu">glm</span>(x[ind,<span class="dv">2</span>]<span class="sc">~</span>x[ind,<span class="dv">1</span>], <span class="at">family=</span><span class="fu">binomial</span>(logit))</span>
<span id="cb281-6"><a href="session-6-reproducible-workflows-revisited.html#cb281-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coefficients</span>(result1)</span>
<span id="cb281-7"><a href="session-6-reproducible-workflows-revisited.html#cb281-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb281-8"><a href="session-6-reproducible-workflows-revisited.html#cb281-8" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>##    user  system elapsed 
##  25.666   0.722  26.692</code></pre>
<div class="sourceCode" id="cb283"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb283-1"><a href="session-6-reproducible-workflows-revisited.html#cb283-1" aria-hidden="true" tabindex="-1"></a><span class="co"># When you&#39;re done, clean up the cluster</span></span>
<span id="cb283-2"><a href="session-6-reproducible-workflows-revisited.html#cb283-2" aria-hidden="true" tabindex="-1"></a><span class="fu">stopImplicitCluster</span>()</span></code></pre></div>
</div>
<div id="summary-1" class="section level3" number="6.2.10">
<h3><span class="header-section-number">6.2.10</span> Summary</h3>
<p>In this lesson, we showed examples of computing tasks that are likely limited by the number of CPU cores that can be applied, and we reviewed the architecture of computers to understand the relationship between CPU processors and cores. Next, we reviewed the way in which traditional <code>for</code> loops in R can be rewritten as functions that are applied to a list serially using <code>lapply</code>, and then how the <code>parallel</code> package <code>mclapply</code> function can be substituted in order to utilize multiple cores on the local computer to speed up computations. Finally, we installed and reviewed the use of the <code>foreach</code> package with the <code>%dopar</code> operator to accomplish a similar parallelization using multiple cores.</p>
</div>
<div id="readings-and-tutorials-1" class="section level3" number="6.2.11">
<h3><span class="header-section-number">6.2.11</span> Readings and tutorials</h3>
<ul>
<li><a href="https://blog.dominodatalab.com/multicore-data-science-r-python/">Multicore Data Science with R and Python</a></li>
<li><a href="https://ljdursi.github.io/beyond-single-core-R/#/">Beyond Single-Core R</a> by Jonoathan Dursi (also see <a href="https://github.com/ljdursi/beyond-single-core-R">GitHub repo for slide source</a>)</li>
<li>The venerable <a href="http://shop.oreilly.com/product/0636920021421.do">Parallel R</a> by McCallum and Weston (a bit dated on the tooling, but conceptually solid)</li>
<li>The <a href="https://cran.r-project.org/web/packages/doParallel/vignettes/gettingstartedParallel.pdf">doParallel Vignette</a></li>
</ul>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="session-5-shiny.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="session-7-communicating-your-research-the-message-box.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
